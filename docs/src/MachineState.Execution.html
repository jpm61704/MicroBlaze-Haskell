<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE UnicodeSyntax #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">MachineState</span><span class="hs-operator">.</span><span class="hs-identifier">Execution</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span>           </span><a href="Control.Monad.Resumption.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Resumption</span></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span>           </span><a href="Control.Monad.Resumption.Reactive.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Resumption</span><span class="hs-operator">.</span><span class="hs-identifier">Reactive</span></a><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span>           </span><a href="Decode.html"><span class="hs-identifier">Decode</span></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span>           </span><a href="InsSet.html"><span class="hs-identifier">InsSet</span></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span>           </span><a href="Interpreter.html"><span class="hs-identifier">Interpreter</span></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span>           </span><a href="MachineState.html"><span class="hs-identifier">MachineState</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span class="hs-operator">.</span><span class="hs-identifier">Unicode</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Word</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-comment">-- data InboundSignals = In { _readData    &#8759; Maybe (MBSize, LoadData, MBReg)</span><span>
</span><a name="line-18"></a><span class="hs-comment">--                          , _instruction &#8759; Maybe Ins</span><span>
</span><a name="line-19"></a><span class="hs-comment">--                          }</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-comment">-- data OutboundSignals = Out { _nextInstruction &#8759; Address</span><span>
</span><a name="line-22"></a><span class="hs-comment">--                            , _read            &#8759; Maybe (Address, MBReg, MBSize)</span><span>
</span><a name="line-23"></a><span class="hs-comment">--                            , _write           &#8759; Maybe (Address, StoreData, MBSize)</span><span>
</span><a name="line-24"></a><span class="hs-comment">--                            , _st             :: MicroBlaze }</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-comment">-- type StoreData = Word32</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- type LoadData  = Word32</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-comment">-- type MBlazeRe m = ReacT InboundSignals OutboundSignals (StateT MicroBlaze m)</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-comment">-- startFDE :: (Monad m) =&gt; MBlazeRe m ()</span><span>
</span><a name="line-33"></a><span class="hs-comment">-- startFDE = fde $ In Nothing Nothing</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-comment">-- fde &#8759; (Monad m) =&gt; InboundSignals &#8594; MBlazeRe m () </span><span>
</span><a name="line-36"></a><span class="hs-comment">-- fde i = do</span><span>
</span><a name="line-37"></a><span class="hs-comment">--   st &#8592; lift get</span><span>
</span><a name="line-38"></a><span class="hs-comment">--   lift $ processIncomingMemory i</span><span>
</span><a name="line-39"></a><span class="hs-comment">--   m_ins &#8592; case _instruction i of</span><span>
</span><a name="line-40"></a><span class="hs-comment">--                 Just raw_ins &#8594; do</span><span>
</span><a name="line-41"></a><span class="hs-comment">--                   -- let ins =  decode raw_ins -- unsafe</span><span>
</span><a name="line-42"></a><span class="hs-comment">--                   lift $ exec raw_ins</span><span>
</span><a name="line-43"></a><span class="hs-comment">--                   return (Just raw_ins)</span><span>
</span><a name="line-44"></a><span class="hs-comment">--                 Nothing      &#8594; return Nothing</span><span>
</span><a name="line-45"></a><span class="hs-comment">--   x &#8592; lift $ makeOutbound m_ins</span><span>
</span><a name="line-46"></a><span class="hs-comment">--   lift $ incrementPC</span><span>
</span><a name="line-47"></a><span class="hs-comment">--   i' &#8592; signal x</span><span>
</span><a name="line-48"></a><span class="hs-comment">--   fde i'</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-comment">-- incrementPC &#8759; (Monad m) =&gt; StateT MicroBlaze m ()</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- incrementPC = do</span><span>
</span><a name="line-52"></a><span class="hs-comment">--   pc &#8592; getRPC</span><span>
</span><a name="line-53"></a><span class="hs-comment">--   let (c, pc') = addWithCarry pc 4 False</span><span>
</span><a name="line-54"></a><span class="hs-comment">--   setRPC pc'</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-comment">-- makeOutbound :: (Monad m) =&gt; Maybe Ins &#8594; StateT MicroBlaze m OutboundSignals</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- makeOutbound Nothing      = do</span><span>
</span><a name="line-58"></a><span class="hs-comment">--   x &lt;- get</span><span>
</span><a name="line-59"></a><span class="hs-comment">--   return $ Out 0 Nothing Nothing x</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- makeOutbound (Just ins)   = liftM4 Out next_ins o_read o_write o_state</span><span>
</span><a name="line-61"></a><span class="hs-comment">--   where next_ins = getRPC</span><span>
</span><a name="line-62"></a><span class="hs-comment">--         o_write  = processWrite ins</span><span>
</span><a name="line-63"></a><span class="hs-comment">--         o_read   = processLoad ins</span><span>
</span><a name="line-64"></a><span class="hs-comment">--         o_state  = get</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">-- processWrite &#8759; (Monad m) =&gt; Ins &#8594; StateT MicroBlaze m (Maybe (Address, StoreData, MBSize))</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- processWrite ins = do</span><span>
</span><a name="line-68"></a><span class="hs-comment">--   case unpackWrite ins of</span><span>
</span><a name="line-69"></a><span class="hs-comment">--     Just (rD, rA, Right rB, size) &#8594; do</span><span>
</span><a name="line-70"></a><span class="hs-comment">--       a &#8592; getRegister rA</span><span>
</span><a name="line-71"></a><span class="hs-comment">--       b &#8592; getRegister rB</span><span>
</span><a name="line-72"></a><span class="hs-comment">--       d &#8592; getRegister rD</span><span>
</span><a name="line-73"></a><span class="hs-comment">--       return $ Just (snd (addWithCarry a b False), d, size)</span><span>
</span><a name="line-74"></a><span class="hs-comment">--     Just (rD, rA, Left imm, size) &#8594; do</span><span>
</span><a name="line-75"></a><span class="hs-comment">--       a &#8592; getRegister rA</span><span>
</span><a name="line-76"></a><span class="hs-comment">--       let b = fromJust $ maybeSignExtend imm</span><span>
</span><a name="line-77"></a><span class="hs-comment">--       d &#8592; getRegister rD</span><span>
</span><a name="line-78"></a><span class="hs-comment">--       return $ Just (snd (addWithCarry a b False), d, size)</span><span>
</span><a name="line-79"></a><span class="hs-comment">--     Nothing &#8594; return Nothing</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">-- unpackWrite &#8759; Ins &#8594; Maybe (MBReg, MBReg, Either Word16 MBReg, MBSize)</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- unpackWrite ins = case ins of</span><span>
</span><a name="line-85"></a><span class="hs-comment">--   Sb rD rA rB   &#8594; Just (rD, rA, Right rB, ByteSize)</span><span>
</span><a name="line-86"></a><span class="hs-comment">--   Sbi rD rA imm &#8594; Just (rD, rA, Left imm, ByteSize)</span><span>
</span><a name="line-87"></a><span class="hs-comment">--   Sh rD rA rB   &#8594; Just (rD, rA, Right rB, HalfWordSize)</span><span>
</span><a name="line-88"></a><span class="hs-comment">--   Shi rD rA imm &#8594; Just (rD, rA, Left imm, HalfWordSize)</span><span>
</span><a name="line-89"></a><span class="hs-comment">--   Sw rD rA rB   &#8594; Just (rD, rA, Right rB, WordSize)</span><span>
</span><a name="line-90"></a><span class="hs-comment">--   Swi rD rA imm &#8594; Just (rD, rA, Left imm, WordSize)</span><span>
</span><a name="line-91"></a><span class="hs-comment">--   _             &#8594; Nothing</span><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-comment">-- processLoad &#8759; (Monad m) =&gt; Ins &#8594; StateT MicroBlaze m (Maybe (Address, MBReg, MBSize))</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- processLoad ins = do</span><span>
</span><a name="line-96"></a><span class="hs-comment">--   case unpackLoad ins of</span><span>
</span><a name="line-97"></a><span class="hs-comment">--     Just (rD, rA, Right rB, size) &#8594; do</span><span>
</span><a name="line-98"></a><span class="hs-comment">--       a &#8592; getRegister rA</span><span>
</span><a name="line-99"></a><span class="hs-comment">--       b &#8592; getRegister rB</span><span>
</span><a name="line-100"></a><span class="hs-comment">--       return $ Just (snd (addWithCarry a b False), rD, size)</span><span>
</span><a name="line-101"></a><span class="hs-comment">--     Just (rD, rA, Left imm, size) &#8594; do</span><span>
</span><a name="line-102"></a><span class="hs-comment">--       a &#8592; getRegister rA</span><span>
</span><a name="line-103"></a><span class="hs-comment">--       return $ Just (snd (addWithCarry a (fromJust $ maybeSignExtend imm) False), rD, size)</span><span>
</span><a name="line-104"></a><span class="hs-comment">--     Nothing                       &#8594; return Nothing</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">-- unpackLoad &#8759; Ins &#8594; Maybe (MBReg, MBReg, Either Word16 MBReg, MBSize)</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- unpackLoad ins = case ins of</span><span>
</span><a name="line-109"></a><span class="hs-comment">--   Lbu rD rA rB   &#8594; Just (rD, rA, Right rB, ByteSize)</span><span>
</span><a name="line-110"></a><span class="hs-comment">--   Lhu rD rA rB   &#8594; Just (rD, rA, Right rB, HalfWordSize)</span><span>
</span><a name="line-111"></a><span class="hs-comment">--   Lw  rD rA rB   &#8594; Just (rD, rA, Right rB, WordSize)</span><span>
</span><a name="line-112"></a><span class="hs-comment">--   Lbui rD rA imm &#8594; Just (rD, rA, Left imm, ByteSize)</span><span>
</span><a name="line-113"></a><span class="hs-comment">--   Lhui rD rA imm &#8594; Just (rD, rA, Left imm, HalfWordSize)</span><span>
</span><a name="line-114"></a><span class="hs-comment">--   Lwi rD rA imm  &#8594; Just (rD, rA, Left imm, WordSize)</span><span>
</span><a name="line-115"></a><span class="hs-comment">--   _              &#8594; Nothing</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-comment">-- processIncomingMemory &#8759; (Monad m) =&gt; InboundSignals &#8594; StateT MicroBlaze m ()</span><span>
</span><a name="line-119"></a><span class="hs-comment">-- processIncomingMemory (In (Just (size, w, rD)) _) = case size of</span><span>
</span><a name="line-120"></a><span class="hs-comment">--   WordSize     &#8594; setRegister rD w</span><span>
</span><a name="line-121"></a><span class="hs-comment">--   HalfWordSize &#8594; (&#8869;)</span><span>
</span><a name="line-122"></a><span class="hs-comment">--   ByteSize     &#8594; (&#8869;)</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- processIncomingMemory _                               = return ()</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a></pre></body></html>